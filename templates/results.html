<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Sentinel-1 Monitor</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .back-link {
            color: #3498db;
            text-decoration: none;
            margin-top: 0.5rem;
            display: inline-block;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .aoi-info {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .aoi-info h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .timeline {
            margin-top: 2rem;
        }
        
        .timeline h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .analysis-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #dee2e6;
        }
        
        .analysis-card.changes {
            border-left-color: #e74c3c;
        }
        
        .analysis-card.no-changes {
            border-left-color: #2ecc71;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .analysis-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge.changes {
            background: #fee;
            color: #c0392b;
        }
        
        .badge.no-changes {
            background: #efe;
            color: #27ae60;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Image viewer */
        .viewer-wrapper {
            display: none;
            margin: 1rem 0;
            gap: 1rem;
        }
        
        .viewer-wrapper.active {
            display: flex;
        }
        
        .viewer-container {
            position: relative;
            flex: 1;
            height: 500px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .image-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-layer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .viewer-controls {
            width: 300px;
            min-width: 300px;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            overflow-y: auto;
            max-height: 500px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
        
        .controls-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .control-group {
            margin-bottom: 1.5rem;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-label {
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .control-label::before {
            content: '';
            font-size: 1rem;
        }
        
        .toggle-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .toggle-btn {
            padding: 0.75rem 1rem;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            color: #495057;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
            font-weight: 500;
        }
        
        .toggle-btn.active {
            background: #3498db;
            border-color: #2980b9;
            color: white;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
        }
        
        .toggle-btn:hover {
            transform: translateX(2px);
            border-color: #3498db;
        }
        
        .toggle-btn.active:hover {
            background: #2980b9;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        
        .slider-value {
            min-width: 50px;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .info-text {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.5rem;
            line-height: 1.4;
        }
        
        .legend-box {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            margin-top: 1.5rem;
        }
        
        .legend-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-title::before {
            content: '';
            font-size: 1rem;
        }
        
        .legend-item {
            font-size: 0.85rem;
            line-height: 1.8;
            color: #495057;
        }
        
        .change-map {
            margin: 1rem 0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .change-map img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .feedback {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.secondary {
            background: #95a5a6;
        }
        
        button.secondary:hover {
            background: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        
        #map {
            height: 400px;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .viewer-wrapper {
                flex-direction: column;
            }
            
            .viewer-controls {
                width: 100%;
                max-width: 100%;
                min-width: 100%;
                max-height: none;
            }
            
            .viewer-controls.collapsed {
                width: 100%;
                min-width: 100%;
            }
            
            .viewer-container {
                height: 400px;
            }
        }
        
        /* Collapsed state visual indicator */
        .viewer-controls.collapsed::before {
            content: '‚ñ∂';
            display: block;
            text-align: center;
            font-size: 1.5rem;
            color: #3498db;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>Analysis Results</h1>
        <a href="/" class="back-link">‚Üê Back to Map</a>
    </header>
    
    <div class="container">
        <div class="aoi-info">
            <h2 id="aoi-name">Loading...</h2>
            <div id="aoi-orbit-info" style="margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px; font-size: 0.9rem; color: #495057;"></div>
            <div id="aoi-map"></div>
        </div>
        
        <div class="timeline">
            <h3>Analysis Timeline</h3>
            <div id="analyses-list"></div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const aoiId = parseInt(window.location.pathname.split('/').pop());
        let aoi = null;
        let analyses = [];
        
        function toggleViewer(index) {
            const wrapper = document.getElementById(`viewer-wrapper-${index}`);
            wrapper.classList.toggle('active');
        }
        
        function updateOpacity(index, layerName, value) {
            const layer = document.getElementById(`${layerName}Layer-${index}`);
            const valueDisplay = document.getElementById(`${layerName}Opacity-${index}`);
            const opacity = value / 100;
            layer.style.opacity = opacity;
            valueDisplay.textContent = value + '%';
        }
        
        async function loadData() {
            try {
                // Load AOI info
                const aoiResponse = await fetch('/api/aois');
                const aois = await aoiResponse.json();
                aoi = aois.find(a => a.id === aoiId);
                
                if (!aoi) {
                    document.querySelector('.container').innerHTML = 
                        '<div class="empty-state"><h2>AOI not found</h2></div>';
                    return;
                }
                
                document.getElementById('aoi-name').textContent = aoi.name;
                
                // Display orbit filtering info
                const orbitInfoDiv = document.getElementById('aoi-orbit-info');
                if (aoi.orbit_direction || aoi.relative_orbit_number) {
                    const orbitParts = [];
                    if (aoi.orbit_direction) orbitParts.push(`Orbit: ${aoi.orbit_direction}`);
                    if (aoi.relative_orbit_number) orbitParts.push(`Track: ${aoi.relative_orbit_number}`);
                    if (aoi.platform_number) orbitParts.push(`Platform: Sentinel-1${aoi.platform_number}`);
                    orbitInfoDiv.innerHTML = `<strong>Change Detection Configuration:</strong> ${orbitParts.join(' ‚Ä¢ ')} <span style="color: #28a745;">Orbit filtering enabled</span>`;
                } else {
                    orbitInfoDiv.innerHTML = '<strong>Legacy AOI:</strong> Orbit filtering not configured. Create new AOI for improved accuracy.';
                    orbitInfoDiv.style.background = '#fff3cd';
                    orbitInfoDiv.style.borderLeft = '3px solid #ffc107';
                }
                
                // Load analyses
                const analysesResponse = await fetch(`/api/analyses/${aoiId}`);
                analyses = await analysesResponse.json();
                
                renderAnalyses();
                renderMap();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        function renderAnalyses() {
            const container = document.getElementById('analyses-list');
            
            if (analyses.length === 0) {
                container.innerHTML = '<div class="empty-state">No analyses yet. Wait for automatic monitoring or trigger manual analysis.</div>';
                return;
            }
            
            container.innerHTML = analyses.map((analysis, i) => {
                const changeClass = analysis.changes_detected ? 'changes' : 'no-changes';
                const badge = analysis.changes_detected ? 
                    '<span class="badge changes">Changes Detected</span>' :
                    '<span class="badge no-changes">No Changes</span>';
                
                return `
                    <div class="analysis-card ${changeClass}">
                        <div class="analysis-header">
                            <div class="analysis-title">
                                ${new Date(analysis.new_image_date).toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}
                            </div>
                            ${badge}
                        </div>
                        
                        ${analysis.changes_detected ? `
                            <div class="stats-grid">
                                <div class="stat">
                                    <div class="stat-label">Changed Area</div>
                                    <div class="stat-value">${analysis.change_area_sqkm.toFixed(4)} km¬≤</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-label">Change Percentage</div>
                                    <div class="stat-value">${analysis.change_percentage.toFixed(2)}%</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-label">Magnitude</div>
                                    <div class="stat-value">${analysis.change_score.toFixed(2)} dB</div>
                                </div>
                            </div>
                            
                            ${analysis.ref_image_url && analysis.new_image_url && analysis.change_map_url ? `
                                <button onclick="toggleViewer(${i})" style="margin: 1rem 0;">
                                    Interactive Viewer
                                </button>
                                
                                <div id="viewer-wrapper-${i}" class="viewer-wrapper">
                                    <div id="viewer-${i}" class="viewer-container">
                                        <div class="image-layer" id="refLayer-${i}" style="opacity: 1; display: flex;">
                                            <img src="${analysis.ref_image_url}" alt="Reference SAR Image">
                                        </div>
                                        <div class="image-layer" id="newLayer-${i}" style="opacity: 0.5; display: flex;">
                                            <img src="${analysis.new_image_url}" alt="New SAR Image">
                                        </div>
                                        <div class="image-layer" id="changeLayer-${i}" style="opacity: 0.7; display: flex;">
                                            <img src="${analysis.change_map_url}" alt="Change Detection Map">
                                        </div>
                                    </div>
                                    
                                    <div id="controls-${i}" class="viewer-controls">
                                        <div class="controls-header">
                                            <div class="controls-title">Layer Transparency</div>
                                        </div>
                                        
                                        <div class="control-group">
                                            <div class="control-label">Reference (${new Date(analysis.reference_date).toLocaleDateString()})</div>
                                            <div class="slider-container">
                                                <input type="range" min="0" max="100" value="100" class="slider" 
                                                       oninput="updateOpacity(${i}, 'ref', this.value)">
                                                <span class="slider-value" id="refOpacity-${i}">100%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="control-group">
                                            <div class="control-label">New Image (${new Date(analysis.new_image_date).toLocaleDateString()})</div>
                                            <div class="slider-container">
                                                <input type="range" min="0" max="100" value="50" class="slider" 
                                                       oninput="updateOpacity(${i}, 'new', this.value)">
                                                <span class="slider-value" id="newOpacity-${i}">50%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="control-group">
                                            <div class="control-label">Change Detection</div>
                                            <div class="slider-container">
                                                <input type="range" min="0" max="100" value="70" class="slider" 
                                                       oninput="updateOpacity(${i}, 'change', this.value)">
                                                <span class="slider-value" id="changeOpacity-${i}">70%</span>
                                            </div>
                                        </div>
                                        
                                        <div class="legend-box">
                                            <div class="legend-title">Legend</div>
                                            <div class="legend-item">üî¥ Red = Decrease in backscatter</div>
                                            <div class="legend-item">üîµ Blue = Increase in backscatter</div>
                                        </div>
                                    </div>
                                </div>
                            ` : analysis.change_map_url ? `
                                <div class="change-map">
                                    <img src="${analysis.change_map_url}" alt="Change detection map">
                                    <p style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem; text-align: center;">
                                        Red = Decrease ‚Ä¢ Blue = Increase
                                    </p>
                                </div>
                            ` : ''}
                        ` : `
                            <p style="color: #6c757d;">No significant changes detected in this analysis.</p>
                        `}
                        
                        ${analysis.notes ? `
                            <p style="margin-top: 1rem; font-style: italic; color: #6c757d;">${analysis.notes}</p>
                        ` : ''}
                        
                        <div class="feedback">
                            <small style="color: #6c757d;">
                                Analyzed: ${new Date(analysis.analysis_date).toLocaleString()}
                                ‚Ä¢ Reference: ${new Date(analysis.reference_date).toLocaleDateString()}
                            </small>
                            ${analysis.changes_detected && !analysis.false_positive ? `
                                <div style="margin-top: 0.5rem;">
                                    <button class="secondary" onclick="markFalsePositive(${analysis.id})">
                                        Mark as False Positive
                                    </button>
                                </div>
                            ` : ''}
                            ${analysis.false_positive ? `
                                <div style="margin-top: 0.5rem; color: #e67e22;">
                                    Marked as false positive
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderMap() {
            if (!aoi) return;
            
            const mapEl = document.getElementById('aoi-map');
            mapEl.id = 'map';
            
            const aoiMap = L.map('map');
            
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            }).addTo(aoiMap);
            
            const layer = L.geoJSON(aoi.geometry, {
                style: {
                    color: '#3498db',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.2
                }
            }).addTo(aoiMap);
            
            aoiMap.fitBounds(layer.getBounds());
        }
        
        async function markFalsePositive(analysisId) {
            const notes = prompt('Optional: Add a note about why this is a false positive:');
            
            try {
                await fetch(`/api/analyses/${analysisId}/feedback`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        false_positive: true,
                        notes: notes || ''
                    })
                });
                
                await loadData();
            } catch (error) {
                console.error('Error marking false positive:', error);
                alert('Failed to update feedback');
            }
        }
        
        // Initial load
        loadData();
    </script>
</body>
</html>
